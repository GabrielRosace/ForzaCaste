{"ast":null,"code":"import * as i0 from \"@angular/core\";\nimport * as i1 from \"../_services/toast.service\";\nimport * as i2 from \"../socketio.service\";\nimport * as i3 from \"../user-http.service\";\nimport * as i4 from \"@angular/router\";\nimport * as i5 from \"@angular/common\";\n\nfunction FriendChatComponent_div_8_div_1_Template(rf, ctx) {\n  if (rf & 1) {\n    i0.ɵɵelementStart(0, \"div\", 13);\n    i0.ɵɵelement(1, \"img\", 14);\n    i0.ɵɵelementStart(2, \"p\");\n    i0.ɵɵtext(3);\n    i0.ɵɵelementEnd();\n    i0.ɵɵelementStart(4, \"span\", 15);\n    i0.ɵɵtext(5);\n    i0.ɵɵelementEnd();\n    i0.ɵɵelementEnd();\n  }\n\n  if (rf & 2) {\n    const message_r4 = i0.ɵɵnextContext().$implicit;\n    i0.ɵɵadvance(1);\n    i0.ɵɵpropertyInterpolate(\"src\", message_r4.imgUrl, i0.ɵɵsanitizeUrl);\n    i0.ɵɵadvance(2);\n    i0.ɵɵtextInterpolate(message_r4.text);\n    i0.ɵɵadvance(2);\n    i0.ɵɵtextInterpolate2(\"\", message_r4.from.toUpperCase(), \" - \", message_r4.time, \"\");\n  }\n}\n\nfunction FriendChatComponent_div_8_div_2_Template(rf, ctx) {\n  if (rf & 1) {\n    i0.ɵɵelementStart(0, \"div\", 16);\n    i0.ɵɵelement(1, \"img\", 17);\n    i0.ɵɵelementStart(2, \"p\");\n    i0.ɵɵtext(3);\n    i0.ɵɵelementEnd();\n    i0.ɵɵelementStart(4, \"span\", 18);\n    i0.ɵɵtext(5);\n    i0.ɵɵelementEnd();\n    i0.ɵɵelementEnd();\n  }\n\n  if (rf & 2) {\n    const message_r4 = i0.ɵɵnextContext().$implicit;\n    i0.ɵɵadvance(1);\n    i0.ɵɵpropertyInterpolate(\"src\", message_r4.imgUrl, i0.ɵɵsanitizeUrl);\n    i0.ɵɵadvance(2);\n    i0.ɵɵtextInterpolate(message_r4.text);\n    i0.ɵɵadvance(2);\n    i0.ɵɵtextInterpolate2(\"\", message_r4.from.toUpperCase(), \" - \", message_r4.time, \"\");\n  }\n}\n\nfunction FriendChatComponent_div_8_Template(rf, ctx) {\n  if (rf & 1) {\n    i0.ɵɵelementStart(0, \"div\", 10);\n    i0.ɵɵtemplate(1, FriendChatComponent_div_8_div_1_Template, 6, 4, \"div\", 11);\n    i0.ɵɵtemplate(2, FriendChatComponent_div_8_div_2_Template, 6, 4, \"div\", 12);\n    i0.ɵɵelementEnd();\n  }\n\n  if (rf & 2) {\n    const message_r4 = ctx.$implicit;\n    i0.ɵɵadvance(1);\n    i0.ɵɵproperty(\"ngIf\", message_r4.from == \"me\");\n    i0.ɵɵadvance(1);\n    i0.ɵɵproperty(\"ngIf\", message_r4.from != \"me\");\n  }\n}\n\nfunction FriendChatComponent_form_9_Template(rf, ctx) {\n  if (rf & 1) {\n    const _r11 = i0.ɵɵgetCurrentView();\n\n    i0.ɵɵelementStart(0, \"form\", 19);\n    i0.ɵɵlistener(\"submit\", function FriendChatComponent_form_9_Template_form_submit_0_listener() {\n      i0.ɵɵrestoreView(_r11);\n\n      const _r9 = i0.ɵɵreference(2);\n\n      const ctx_r10 = i0.ɵɵnextContext();\n      ctx_r10.sendMessage(_r9.value);\n      return false;\n    });\n    i0.ɵɵelement(1, \"input\", 20, 21);\n    i0.ɵɵelementStart(3, \"button\", 22);\n    i0.ɵɵlistener(\"click\", function FriendChatComponent_form_9_Template_button_click_3_listener() {\n      i0.ɵɵrestoreView(_r11);\n\n      const _r9 = i0.ɵɵreference(2);\n\n      const ctx_r12 = i0.ɵɵnextContext();\n      return ctx_r12.sendMessage(_r9.value);\n    });\n    i0.ɵɵtext(4, \"Send\");\n    i0.ɵɵelementEnd();\n    i0.ɵɵelementEnd();\n  }\n}\n\nfunction FriendChatComponent_form_10_Template(rf, ctx) {\n  if (rf & 1) {\n    i0.ɵɵelementStart(0, \"form\", 23);\n    i0.ɵɵelement(1, \"input\", 24, 21);\n    i0.ɵɵelementEnd();\n  }\n}\n\nexport let FriendChatComponent = /*#__PURE__*/(() => {\n  class FriendChatComponent {\n    constructor(toast, sio, us, router, activeRoute, cdRef) {\n      this.toast = toast;\n      this.sio = sio;\n      this.us = us;\n      this.router = router;\n      this.activeRoute = activeRoute;\n      this.cdRef = cdRef;\n      this.singleChat = [];\n      this.username = \"\"; //TODO tipo user\n\n      this.friend = \"\";\n      this.avatarImgURL = \"\";\n      this.tok = \"\";\n      this.badgeContentMsg = 0;\n      this.hideMatBadgeMsg = false;\n      this.role = \"\";\n      this.type = \"\";\n      /*\n       this.subscriptionName = this.us.get_userMessage().subscribe((elem: any) => {\n         console.log(\"OpenChat\")\n         let username = this.activeRoute.snapshot.params['friend']\n         this.messagelist = elem.allMessages\n         this.messageInpending = elem.inPendingMessages\n         this.us.get_friend(username).subscribe((friend) => {\n           this.messagelist.forEach((element: any) => {\n             let date = new Date(element.timestamp);\n             if (element.sender == username) {\n               //date.getUTCDay().toString()+\"-\"+date.getUTCMonth().toString()+\"-\"+date.getFullYear().toString()+\" \"+date.getUTCHours().toString()+\":\"+date.getUTCMinutes().toString()\n               this.singleChat.push({ imgUrl: friend.avatarImgURL, from: friend.username, text: element.content, time: date.toUTCString() });\n             } else if (element.receiver == username) {\n               this.singleChat.push({ imgUrl: this.us.get_avatarImgURL(), from: \"me\", text: element.content, time: date.toUTCString() });\n             }\n           })\n           /*\n           let date = new Date(element.timestamp);\n           if (element.sender == username) {\n             this.us.readMessage(this.us.get_username(), username)\n             this.singleChat.push({ imgUrl: friend.avatarImgURL, from: friend.username, text: element.content, time: date.toUTCString() });\n           } else if (element.receiver == username) {\n             this.us.readMessage(username, this.us.get_username())\n             this.singleChat.push({ imgUrl: this.us.get_avatarImgURL(), from: \"me\", text: element.content, time: date.toUTCString()});\n           }\n         })\n               this.badgeContentMsg = 0\n         //console.log(\"MsgList: \")\n         //console.log(this.messageInpending)\n         this.messageInpending.forEach((element: any) => {\n           if (element.receiver == this.us.get_username()) {\n             this.badgeContentMsg++;\n           }\n         });\n               //console.log(\"badgeContent\")\n         //console.log(this.badgeContentMsg)\n         if (this.badgeContentMsg == 0) {\n           this.hideMatBadgeMsg = true\n         }\n       })*/\n    }\n\n    ngOnInit() {\n      this.tok = this.us.get_token();\n      console.log(\"Sono ngInit Friend\");\n\n      if (!this.tok) {\n        // TODO aggiungi un messaggio, magari con una funzione nel servizio per non replicare codice\n        this.router.navigate(['/']);\n      } else {\n        this.username = this.us.get_username();\n        this.avatarImgURL = this.us.get_avatarImgURL();\n        this.role = this.us.get_role();\n        this.friend = this.activeRoute.snapshot.params['friend'];\n        this.imBlocked();\n        this.readMessage(this.us.get_username(), this.activeRoute.snapshot.params['friend']);\n        this.openChat(this.activeRoute.snapshot.params['friend']);\n        this.notifyNewMsg();\n        this.notifyBlocked();\n        console.log(this.router.parseUrl(this.router.url).root.children.primary.segments[0].path); //this.getNotification(false, true)\n      }\n    }\n\n    ngOnDestroy() {\n      if (this.tok) {\n        this.subscriptionName.unsubscribe();\n        this.subscriptionMsg.unsubscribe();\n      }\n    }\n\n    ngAfterViewChecked() {\n      this.cdRef.detectChanges();\n    }\n\n    sendMessage(message) {\n      this.us.send_chatMsg(this.activeRoute.snapshot.params['friend'], message).subscribe(data => {\n        let date = new Date();\n        this.singleChat.push({\n          imgUrl: this.us.get_avatarImgURL(),\n          from: \"me\",\n          text: message,\n          time: `${date.getUTCHours()}:${date.getMinutes()}:${date.getUTCSeconds()} - ${date.getUTCDate()}/${date.getUTCMonth() + 1}/${date.getFullYear()}`\n        });\n      });\n    }\n\n    imBlocked() {\n      this.us.get_friend(this.activeRoute.snapshot.params['friend']).subscribe(friend => {\n        let fr;\n        friend.friendList.filter(u => {\n          if (u.username == this.us.get_username()) {\n            fr = u.isBlocked;\n          }\n        });\n        console.log(\"Blocked: \"); //this.imBlock = fr.isBlocked\n\n        console.log(fr);\n        this.imBlock = fr;\n      });\n    }\n\n    openChat(username) {\n      this.subscriptionName = this.us.get_userMessage().subscribe(elem => {\n        console.log(\"OpenChat\");\n        this.messagelist = elem.allMessages;\n        this.messageInpending = elem.inPendingMessages;\n        this.us.get_friend(username).subscribe(friend => {\n          this.messagelist.forEach(element => {\n            let date = new Date(element.timestamp);\n\n            if (element.sender == username) {\n              //date.getUTCDay().toString()+\"-\"+date.getUTCMonth().toString()+\"-\"+date.getFullYear().toString()+\" \"+date.getUTCHours().toString()+\":\"+date.getUTCMinutes().toString()\n              this.singleChat.push({\n                imgUrl: friend.avatarImgURL,\n                from: friend.username,\n                text: element.content,\n                time: `${date.getUTCHours()}:${date.getMinutes()}:${date.getUTCSeconds()} - ${date.getUTCDate()}/${date.getUTCMonth() + 1}/${date.getFullYear()}`\n              });\n              console.log(`${date.getUTCHours()}:${date.getMinutes()}:${date.getUTCSeconds()} - ${date.getUTCDate()}/${date.getUTCMonth() + 1}/${date.getFullYear()}`); //! Date parsing\n            } else if (element.receiver == username) {\n              this.singleChat.push({\n                imgUrl: this.us.get_avatarImgURL(),\n                from: \"me\",\n                text: element.content,\n                time: `${date.getUTCHours()}:${date.getMinutes()}:${date.getUTCSeconds()} - ${date.getUTCDate()}/${date.getUTCMonth() + 1}/${date.getFullYear()}`\n              });\n            }\n          });\n          /*\n          let date = new Date(element.timestamp);\n          if (element.sender == username) {\n            this.us.readMessage(this.us.get_username(), username)\n            this.singleChat.push({ imgUrl: friend.avatarImgURL, from: friend.username, text: element.content, time: date.toUTCString() });\n          } else if (element.receiver == username) {\n            this.us.readMessage(username, this.us.get_username())\n            this.singleChat.push({ imgUrl: this.us.get_avatarImgURL(), from: \"me\", text: element.content, time: date.toUTCString()});\n          }*/\n        });\n        this.badgeContentMsg = 0; //console.log(\"MsgList: \")\n        //console.log(this.messageInpending)\n\n        this.messageInpending.forEach(element => {\n          if (element.receiver == this.us.get_username()) {\n            this.badgeContentMsg++;\n          }\n        }); //console.log(\"badgeContent\")\n        //console.log(this.badgeContentMsg)\n\n        if (this.badgeContentMsg == 0) {\n          this.hideMatBadgeMsg = true;\n        }\n      });\n    }\n\n    readMessage(myus, username) {\n      this.us.readMessage(myus, username, false).subscribe(() => {\n        this.us.update_badge(\"read friend-chat\");\n      });\n    }\n\n    getInpendinMsg(username) {\n      this.subscriptionName = this.us.get_userMessage().subscribe(elem => {\n        this.messageInpending = elem.inPendingMessages;\n        this.badgeContentMsg = 0;\n        this.us.get_friend(username).subscribe(friend => {\n          this.messageInpending.forEach(element => {\n            let date = new Date(element.timestamp);\n\n            if (element.sender == username) {\n              //date.getUTCDay().toString()+\"-\"+date.getUTCMonth().toString()+\"-\"+date.getFullYear().toString()+\" \"+date.getUTCHours().toString()+\":\"+date.getUTCMinutes().toString()\n              this.singleChat.push({\n                imgUrl: friend.avatarImgURL,\n                from: friend.username,\n                text: element.content,\n                time: `${date.getUTCHours()}:${date.getMinutes()}:${date.getUTCSeconds()} - ${date.getUTCDate()}/${date.getUTCMonth() + 1}/${date.getFullYear()}`\n              });\n            }\n          });\n          this.us.readMessage(this.us.get_username(), username, false).subscribe();\n        });\n      });\n    }\n\n    notifyBlocked() {\n      if (!this.sio.isNull()) {\n        this.sio.beingBlocked().subscribe(msg => {\n          this.imBlock = JSON.parse(JSON.stringify(msg)).blocked;\n        });\n      }\n    }\n\n    notifyNewMsg() {\n      if (!this.sio.isNull()) {\n        this.subscriptionMsg = this.sio.newMessage().subscribe(msg => {\n          this.getInpendinMsg(this.activeRoute.snapshot.params['friend']);\n        });\n      }\n    }\n\n  }\n\n  FriendChatComponent.ɵfac = function FriendChatComponent_Factory(t) {\n    return new (t || FriendChatComponent)(i0.ɵɵdirectiveInject(i1.ToastService), i0.ɵɵdirectiveInject(i2.SocketioService), i0.ɵɵdirectiveInject(i3.UserHttpService), i0.ɵɵdirectiveInject(i4.Router), i0.ɵɵdirectiveInject(i4.ActivatedRoute), i0.ɵɵdirectiveInject(i0.ChangeDetectorRef));\n  };\n\n  FriendChatComponent.ɵcmp = /*@__PURE__*/i0.ɵɵdefineComponent({\n    type: FriendChatComponent,\n    selectors: [[\"app-friend-chat\"]],\n    decls: 11,\n    vars: 5,\n    consts: [[\"id\", \"main\", 1, \"card\", \"border-dark\", \"mb-0\", \"p-0\"], [1, \"card-body\", \"text-dark\"], [1, \"text-center\", \"fs-2\", \"fw-bold\"], [1, \"container\"], [1, \"mychat\"], [1, \"chatcontainer\", 3, \"scrollTop\"], [\"scrollMe\", \"\"], [\"class\", \"elements\", 4, \"ngFor\", \"ngForOf\"], [\"class\", \"form-inline\", \"style\", \"padding-left: 1vw;padding-right: 1vw; padding-top: 1vw;\", 3, \"submit\", 4, \"ngIf\"], [\"class\", \"form-inline\", \"style\", \"padding-left: 1vw;padding-right: 1vw; padding-top: 1vw;\", 4, \"ngIf\"], [1, \"elements\"], [\"class\", \"containerchat\", 4, \"ngIf\"], [\"class\", \"containerchat darker\", 4, \"ngIf\"], [1, \"containerchat\"], [\"alt\", \"\", \"width\", \"32\", \"height\", \"32\", 1, \"rounded-circle\", \"me-2\", 2, \"float\", \"left\", 3, \"src\"], [1, \"time-right\"], [1, \"containerchat\", \"darker\"], [\"alt\", \"\", \"width\", \"32\", \"height\", \"32\", 1, \"rounded-circle\", \"me-2\", 2, \"float\", \"right\", 3, \"src\"], [1, \"time-left\"], [1, \"form-inline\", 2, \"padding-left\", \"1vw\", \"padding-right\", \"1vw\", \"padding-top\", \"1vw\", 3, \"submit\"], [\"type\", \"text\", \"id\", \"inlineFormInputName2\", \"placeholder\", \"Write something\", 1, \"form-control\", \"mb-2\", \"mr-sm-2\"], [\"tosend\", \"\"], [\"type\", \"button\", 1, \"w-100\", \"btn\", \"btn-lg\", \"btn-primary\", 3, \"click\"], [1, \"form-inline\", 2, \"padding-left\", \"1vw\", \"padding-right\", \"1vw\", \"padding-top\", \"1vw\"], [\"type\", \"text\", \"id\", \"inlineFormInputName2\", \"placeholder\", \"You have been blocked by your friend\", \"disabled\", \"\", 1, \"form-control\", \"mb-2\", \"mr-sm-2\"]],\n    template: function FriendChatComponent_Template(rf, ctx) {\n      if (rf & 1) {\n        i0.ɵɵelementStart(0, \"div\", 0);\n        i0.ɵɵelementStart(1, \"div\", 1);\n        i0.ɵɵelementStart(2, \"p\", 2);\n        i0.ɵɵtext(3);\n        i0.ɵɵelementEnd();\n        i0.ɵɵelementStart(4, \"div\", 3);\n        i0.ɵɵelementStart(5, \"div\", 4);\n        i0.ɵɵelementStart(6, \"div\", 5, 6);\n        i0.ɵɵtemplate(8, FriendChatComponent_div_8_Template, 3, 2, \"div\", 7);\n        i0.ɵɵelementEnd();\n        i0.ɵɵtemplate(9, FriendChatComponent_form_9_Template, 5, 0, \"form\", 8);\n        i0.ɵɵtemplate(10, FriendChatComponent_form_10_Template, 3, 0, \"form\", 9);\n        i0.ɵɵelementEnd();\n        i0.ɵɵelementEnd();\n        i0.ɵɵelementEnd();\n        i0.ɵɵelementEnd();\n      }\n\n      if (rf & 2) {\n        const _r0 = i0.ɵɵreference(7);\n\n        i0.ɵɵadvance(3);\n        i0.ɵɵtextInterpolate1(\"Friend chat with \", ctx.friend, \"\");\n        i0.ɵɵadvance(3);\n        i0.ɵɵproperty(\"scrollTop\", _r0.scrollHeight);\n        i0.ɵɵadvance(2);\n        i0.ɵɵproperty(\"ngForOf\", ctx.singleChat);\n        i0.ɵɵadvance(1);\n        i0.ɵɵproperty(\"ngIf\", !ctx.imBlock);\n        i0.ɵɵadvance(1);\n        i0.ɵɵproperty(\"ngIf\", ctx.imBlock);\n      }\n    },\n    directives: [i5.NgForOf, i5.NgIf],\n    styles: [\"#main[_ngcontent-%COMP%]{display:flex;justify-content:center;height:100vh}.chatcontainer[_ngcontent-%COMP%]{overflow-y:scroll}.containerchat[_ngcontent-%COMP%]{border:.5px solid #dedede;background-color:#b8cfe6;border-radius:5px;padding:10px;margin:10px 0}.darker[_ngcontent-%COMP%]{border-color:#ccc;background-color:#acd8bc}.containerchat[_ngcontent-%COMP%]:after{content:\\\"\\\";clear:both;display:table}@media (orientation: landscape){.chatcontainer[_ngcontent-%COMP%]{display:block;max-width:100%;width:100%;max-height:65vh;height:65vh;overflow-y:scroll;background-color:#f5f5f5;border-style:solid;border-radius:10px;border-width:1pt}.mychat[_ngcontent-%COMP%]{width:100%;max-width:100%;max-height:70vh}.container[_ngcontent-%COMP%]   img[_ngcontent-%COMP%]{float:left;max-width:7vh;max-height:7vh;width:7vh;height:7vh;background-size:contain;margin-right:20px;border-radius:50%}.container[_ngcontent-%COMP%]   img.right[_ngcontent-%COMP%]{float:right;margin-left:20px;margin-right:0}}@media (orientation: portrait){.chatcontainer[_ngcontent-%COMP%]{max-width:100%;width:100%;max-height:65vh;height:65vh;overflow-y:scroll;background-color:#f5f5f5;border-style:solid;border-radius:10px;border-width:1pt}.mychat[_ngcontent-%COMP%]{width:100%;max-width:100%;max-height:70vw}.container[_ngcontent-%COMP%]   img[_ngcontent-%COMP%]{max-width:7vw;max-height:7vw;width:7vw;height:7vw;background-size:contain;margin-right:20px;border-radius:50%}.container[_ngcontent-%COMP%]   img.right[_ngcontent-%COMP%]{float:right;margin-left:20px;margin-right:0}}.time-right[_ngcontent-%COMP%]{float:right;color:#aaa}.time-left[_ngcontent-%COMP%]{float:left;color:#999}\"]\n  });\n  return FriendChatComponent;\n})();","map":null,"metadata":{},"sourceType":"module"}